---
const { equipo } = Astro.props as { equipo: any };

// Utilidad fecha dd/mm/yyyy
function ddmmyyyy(ymd: string) {
  if (!ymd) return '';
  const y = ymd.slice(0, 4), m = ymd.slice(5, 7), d = ymd.slice(8, 10);
  return (y && m && d) ? `${d}/${m}/${y}` : '';
}
const hoyYMD = new Date().toISOString().slice(0, 10);
const fechaMostrar = ddmmyyyy((equipo?.fecha_de_entrega as string) || hoyYMD);

function formatARS(v?: string | number | null): string {
  if (v == null || v === '') return '';
  const n = Number(String(v).replace(/[^\d,-]/g, '').replace(',', '.'));
  if (!isFinite(n)) return String(v);
  return new Intl.NumberFormat('es-AR', {
    style: 'currency',
    currency: 'ARS',
    minimumFractionDigits: 0,
    maximumFractionDigits: 2
  }).format(n);
}
---

<form method="POST" action={`/api/actualizarDelivery?id=${equipo.ticketId}`} class="row g-3">
  <div class="col-md-6">
    <label class="form-label">Costo delivery</label>
    <input
      type="text"
      class="form-control currency-ars"
      name="cotizar_delivery"
      value={formatARS(equipo?.cotizar_delivery ?? '')}
      placeholder="$500"
    />
  </div>

  <div class="col-md-6">
    <label class="form-label">Medio de entrega</label>
    <input
      type="text"
      class="form-control"
      name="medio_de_entrega"
      value={equipo?.medio_de_entrega ?? ''}
      placeholder="Moto, correo, etc."
    />
  </div>

  <div class="col-md-6">
    <label class="form-label">Dirección</label>
    <input
      type="text"
      class="form-control"
      name="direccion"
      value={equipo?.direccion ?? ''}
      placeholder="Calle, número, piso/depto"
    />
  </div>

  <div class="col-md-6">
    <label class="form-label">Localidad</label>
    <input
      type="text"
      class="form-control"
      name="localidad"
      value={equipo?.localidad ?? ''}
      placeholder="Ciudad / localidad"
    />
  </div>

  <div class="col-md-6">
    <label class="form-label">Fecha de entrega</label>
    <input type="text" class="form-control" value={fechaMostrar} readonly />
    <div class="form-text">Se completa automáticamente al guardar.</div>
  </div>

  <div class="col-md-6">
    <label class="form-label">Forma de pago</label>
    <input
      type="text"
      class="form-control"
      name="forma_de_pago"
      value={equipo?.forma_de_pago ?? ''}
      placeholder="Transferencia, efectivo..."
    />
  </div>

  <div class="col-12">
    <label class="form-label">Información adicional</label>
    <textarea
      class="form-control"
      name="informacion_adicional_delivery"
      rows="3"
      placeholder="Notas, referencias, aclaraciones..."
    >{equipo?.informacion_adicional_delivery ?? ''}</textarea>
  </div>

  <div class="col-12">
    <label class="form-label">¿Pagado?</label>
    <select name="pagado" class="form-select">
      <option value="" selected={!equipo?.pagado}>Seleccionar</option>
      <option value="true" selected={equipo?.pagado === 'true'}>Sí</option>
      <option value="false" selected={equipo?.pagado === 'false'}>No</option>
    </select>
  </div>

  <div class="col-12 d-flex justify-content-end">
    <button type="submit" class="btn btn-success">
      <i class="bi bi-save me-1"></i> Guardar delivery
    </button>
  </div>
</form>

<script>
(function(){
  function parseNumber(s){
    if(!s) return 0;
    s = s.replace(/[^\d,-]/g,'').replace(',', '.');
    return Number(s) || 0;
  }
  function formatARS(n){
    return new Intl.NumberFormat('es-AR',{
      style:'currency',currency:'ARS',
      minimumFractionDigits:0, maximumFractionDigits:2
    }).format(n);
  }
  function onBlur(e){
    const n = parseNumber(e.target.value);
    e.target.value = n ? formatARS(n) : '';
  }
  function onInput(e){
    e.target.value = e.target.value.replace(/[^\d,.-]/g,'');
  }
  document.querySelectorAll('.currency-ars').forEach(el=>{
    el.addEventListener('blur', onBlur);
    el.addEventListener('input', onInput);
  });
})();
</script>
