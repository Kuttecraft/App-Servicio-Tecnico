---
/**
 * PrinterCard.astro
 * Muestra una tarjeta de ticket/impresora.
 * - Label "M√°quina" pero leyendo el valor desde `modelo` (fallback: `maquina`).
 * - Prioridad de im√°genes: imagen_ticket > imagen > imagen_extra > /logo.webp.
 */

export interface Props {
  id?: number | string;
  ticket?: number | string;
  cliente?: string;
  modelo?: string | null;       // üëà fuente real para ‚ÄúM√°quina‚Äù
  maquina?: string | null;      // fallback por compatibilidad
  estado?: string;
  whatsapp?: string | null;

  onClickUrl?: string;          // link al detalle
  onClickUrlEditar?: string;    // link a editar

  imagen?: string | null;       // urls posibles (prioridad m√°s baja que imagen_ticket)
  imagen_ticket?: string | null; // prioridad m√°s alta
  imagen_extra?: string | null; // √∫ltima opci√≥n antes del logo
}

const {
  id,
  ticket = "Sin ticket",
  cliente = "Desconocido",

  // Preferimos 'modelo'; mantenemos 'maquina' como fallback por compatibilidad
  modelo: modeloProp = undefined,
  maquina: maquinaProp = undefined,

  estado = "Sin estado",
  whatsapp = "No especificado",

  onClickUrl = "#",
  onClickUrlEditar = "#",

  // Im√°genes
  imagen = null,
  imagen_ticket = null,
  imagen_extra = null,
} = Astro.props as Props;

// üëâ Texto mostrado para "M√°quina": 1) modelo 2) maquina 3) "Desconocido"
const modelo =
  (modeloProp && String(modeloProp).trim()) ||
  (maquinaProp && String(maquinaProp).trim()) ||
  "Desconocido";

// Prioridad de im√°genes para cubrir casos faltantes
// 1) imagen_ticket  2) imagen  3) imagen_extra  4) logo por defecto
const imagenFinal =
  (imagen_ticket && String(imagen_ticket)) ||
  (imagen && String(imagen)) ||
  (imagen_extra && String(imagen_extra)) ||
  "/logo.webp";

// üé® Paleta pastel por estado (solo fondo de card)
const estadoColores: Record<string, string> = {
  "Nuevo": "#E2FFF6",
  "Retirar": "#FFE9CC",
  "Presupuestar": "#FFD9D9",
  "Enviar presupuesto": "#E9FCEC",
  "P. Enviado": "#D9EBFF",
  "Reparaci√≥n": "#FFFDE1",
  "Prueba": "#E3DBFF",
  "Lista": "#FFE3DC",
  "Entregada": "#E6F6FF",
  "Feedback Enviado": "#FAE4F6",
  "Archivada": "#EDEDED",
  "No realizada": "#FFF1D9"
};

// Color de fondo seg√∫n estado; por defecto blanco si no hay match
const colorEstado = estadoColores[estado] || "#FFFFFF";

// Texto alternativo accesible para la imagen
const altImagen = `Imagen del equipo de ${cliente}`;
---

<style>
  /* Card de altura uniforme / layout base */
  .pcard {
    display: flex;
    flex-direction: column;
    border-radius: 15px;
    min-width: 220px;
    transition: transform 0.15s ease;
    border: 1px solid rgba(0,0,0,.06); /* contorno sutil */
  }

  .pcard:hover { transform: translateY(-3px); }

  /* Contenedor cuadrado para la imagen (mantiene relaci√≥n 1:1) */
  .pcard__imgwrap {
    width: 200px;
    aspect-ratio: 1 / 1;
    border-radius: 15px;
    overflow: hidden;
    margin: .25rem auto .5rem auto; /* centrado */
    box-shadow: 0 2px 8px rgba(0,0,0,.08);
    border: 1px solid rgba(0,0,0,.06);
    background: #f5f6f8; /* placeholder mientras carga */
  }

  .pcard__img {
    width: 100%;
    height: 100%;
    object-fit: cover;   /* recorta sin deformar */
    display: block;
  }

  .pcard__body {         /* zona de contenidos */
    padding: .25rem .5rem 0 .5rem;
  }

  .pcard__footer {       /* fija los botones abajo */
    margin-top: auto;
    padding-top: .5rem;
  }

  .btn-ver-card, .btn-editar-card {
    border: 1px solid rgba(0,0,0,.12);
    border-radius: 8px;
    text-decoration: none;
    font-size: .9rem;
  }

  /* Evita que textos largu√≠simos rompan el layout */
  .truncate {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
</style>

<!-- Card con fondo dependiente del estado -->
<div class="card shadow-sm p-3 mb-4 text-center pcard h-100"
     style={`background-color: ${colorEstado}`}>
  <div class="pcard__imgwrap">
    <img
      class="pcard__img"
      src={`${imagenFinal}?t=${Date.now()}`}  
      loading="lazy"
    />
  </div>

  <div class="pcard__body">
    <!-- Cliente como t√≠tulo (truncado si es largo) -->
    <h6 class="fw-bold text-dark mt-1 mb-1 truncate" title={cliente} style="font-size:1.12rem;">
      {cliente}
    </h6>

    <!-- Lista de atributos clave -->
    <ul class="list-unstyled mb-2 small text-secondary">
      <li><strong>ID:</strong> {id}</li>
      <li><strong>Ticket:</strong> {ticket}</li>
      <!-- üëá label ‚ÄúM√°quina‚Äù pero valor real desde `modelo` -->
      <li class="truncate" title={modelo}><strong>M√°quina:</strong> {modelo}</li>
      <li><strong>Estado:</strong> {estado}</li>
      <li class="truncate" title={whatsapp || 'No especificado'}><strong>WhatsApp:</strong> {whatsapp || 'No especificado'}</li>
    </ul>
  </div>

  <!-- Acciones principales -->
  <div class="pcard__footer d-flex gap-2 justify-content-center">
    <a href={onClickUrl} class="btn-ver-card px-3 py-1">Ver</a>
    <a href={onClickUrlEditar} class="btn-editar-card px-3 py-1">Editar</a>
  </div>
</div>
