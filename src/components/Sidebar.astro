---
type Binario = boolean | string | 0 | 1;
type Perfil = {
  rol?: string;                      // 'admin' | 'tecnico'
  admin?: Binario;                   // redundante, por si viene
  tickets?: Binario;
  usuarios?: Binario;
  estadisticas?: Binario;
};

const props = Astro.props as { mobile?: boolean; perfil?: Perfil };
const mobile = props?.mobile ?? false;

// üîê Tomamos perfil de props o, si no lo pasan, desde locals (lo que setea tu middleware)
// Esto evita que quede todo visible cuando no te pasan nada por props.
const perfil: Perfil =
  (props?.perfil as Perfil) ??
  (((Astro.locals as any)?.perfil as Perfil) ?? {});

// Helpers
const asBool = (v: Binario | undefined): boolean =>
  v === true || v === 1 || v === '1' || v === 'true';

const isAdmin   = (perfil?.rol === 'admin') || asBool(perfil?.admin);
const isTecnico = (perfil?.rol === 'tecnico');

// ‚öñÔ∏è ‚ÄúClamp‚Äù de permisos: las flags NUNCA elevan por encima del rol.
// - Para admin: si hay flag la respeto, si no hay => true.
// - Para t√©cnico: siempre false (aunque venga 'true' desde la DB).
const allowAdminOnly = (flag?: Binario) =>
  isAdmin ? (flag === undefined ? true : asBool(flag)) : false;

// Visibilidad final
const veTickets        = perfil.tickets      !== undefined ? asBool(perfil.tickets)      : true; // todos ven tickets
const veMisEstadisticas= true;  // todos ven su panel de m√©tricas

// admin-only
const veUsuarios       = allowAdminOnly(perfil.usuarios);
const veEstadisticas   = allowAdminOnly(perfil.estadisticas);
const veRepuestos      = allowAdminOnly(undefined); // sin flag: admin siempre, t√©cnico nunca

// UI helpers
const currentPath = Astro.url.pathname;
const isActive = (href: string) => (currentPath === href ? 'active' : '');
---

{!mobile ? (
  <aside class="d-none d-md-flex flex-column bg-dark text-white p-3"
    style="position: fixed; top: 0; left: 0; height: 100vh; width: 240px; z-index: 1030;">
    <h4 class="text-center mb-4">Servicio T√©cnico</h4>

    <nav class="nav nav-pills flex-column gap-2">
      <a class={`nav-link text-white d-flex align-items-center gap-2 ${isActive('/dashboard')}`} href="/dashboard">
        <i class="bi bi-house"></i> Inicio
      </a>

      {veTickets && (
        <a class={`nav-link text-white d-flex align-items-center gap-2 ${isActive('/addTicket')}`} href="/addTicket">
          <i class="bi bi-ticket-detailed"></i> Tickets
        </a>
      )}

      {veUsuarios && (
        <a class={`nav-link text-white d-flex align-items-center gap-2 ${isActive('/usuarios')}`} href="/usuarios">
          <i class="bi bi-people"></i> Usuarios
        </a>
      )}

      {veEstadisticas && (
        <a class={`nav-link text-white d-flex align-items-center gap-2 ${isActive('/estadisticas')}`} href="/estadisticas">
          <i class="bi bi-bar-chart-line"></i> Estad√≠sticas
        </a>
      )}

      {veRepuestos && (
        <a class={`nav-link text-white d-flex align-items-center gap-2 ${isActive('/repuesto')}`} href="/repuesto">
          <i class="bi bi-box-seam"></i> Repuestos
        </a>
      )}

      {veMisEstadisticas && (
        <a class={`nav-link text-white d-flex align-items-center gap-2 ${isActive('/estadisticas-tecnico')}`} href="/estadisticas-tecnico">
          <i class="bi bi-person-lines-fill"></i> Mis estad√≠sticas
        </a>
      )}
    </nav>
  </aside>
) : (
  <div class="offcanvas offcanvas-start bg-dark text-white" tabindex="-1" id="mobileSidebar" aria-labelledby="mobileSidebarLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="mobileSidebarLabel">Men√∫</h5>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Cerrar"></button>
    </div>
    <div class="offcanvas-body d-flex flex-column">
      <a class={`nav-link text-white mb-2 d-flex align-items-center gap-2 ${isActive('/dashboard')}`} href="/dashboard">
        <i class="bi bi-house"></i> Inicio
      </a>

      {veTickets && (
        <a class={`nav-link text-white mb-2 d-flex align-items-center gap-2 ${isActive('/addTicket')}`} href="/addTicket">
          <i class="bi bi-ticket-detailed"></i> Tickets
        </a>
      )}

      {veUsuarios && (
        <a class={`nav-link text-white mb-2 d-flex align-items-center gap-2 ${isActive('/usuarios')}`} href="/usuarios">
          <i class="bi bi-people"></i> Usuarios
        </a>
      )}

      {veEstadisticas && (
        <a class={`nav-link text-white mb-2 d-flex align-items-center gap-2 ${isActive('/estadisticas')}`} href="/estadisticas">
          <i class="bi bi-bar-chart-line"></i> Estad√≠sticas
        </a>
      )}

      {veRepuestos && (
        <a class={`nav-link text-white mb-2 d-flex align-items-center gap-2 ${isActive('/repuesto')}`} href="/repuesto">
          <i class="bi bi-box-seam"></i> Repuestos
        </a>
      )}

      {veMisEstadisticas && (
        <a class={`nav-link text-white mb-2 d-flex align-items-center gap-2 ${isActive('/estadisticas-tecnico')}`} href="/estadisticas-tecnico">
          <i class="bi bi-person-lines-fill"></i> Mis estad√≠sticas
        </a>
      )}
    </div>
  </div>
)}
