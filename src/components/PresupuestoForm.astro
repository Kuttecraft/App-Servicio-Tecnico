---
const { equipo } = Astro.props as { equipo: any };
const isVerificar = Boolean(equipo?.id);

function formatARS(v?: string | number | null): string {
  if (v == null || v === '') return '';
  const digits = String(v).replace(/[^\d]/g, '');
  const n = Number(digits);
  if (!isFinite(n)) return String(v);
  return new Intl.NumberFormat('es-AR', {
    style: 'currency',
    currency: 'ARS',
    minimumFractionDigits: 0,
    maximumFractionDigits: 0
  }).format(n);
}
---

<form id="presupuesto-form" method="POST" action={`/api/actualizarPresupuesto?id=${equipo.ticketId}`} class="card shadow-sm">
  <div class="card-body">
    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label">Monto</label>
        <input
          type="text"
          class="form-control currency-ars"
          name="monto"
          value={formatARS(equipo?.monto ?? '')}
          placeholder="$20.000"
        />
      </div>

      <div class="col-md-6">
        <label class="form-label">Link presupuesto</label>
        <input
          type="url"
          class="form-control"
          name="link_presupuesto"
          value={equipo?.link_presupuesto ?? ''}
          autocomplete="off"
        />
      </div>

      <div class="col-md-6">
        <label class="form-label">¿Garantía activa?</label>
        <select name="garantia_activa" class="form-select">
          <option value="">Seleccionar</option>
          <option value="Sí" selected={equipo?.garantia_activa === 'Sí'}>Sí</option>
          <option value="No" selected={equipo?.garantia_activa === 'No'}>No</option>
        </select>
      </div>

      <div class="col-md-6">
        <label class="form-label">¿Quiere saber presupuesto?</label>
        <select name="solicitar_presupuesto" class="form-select">
          <option value="" selected={!(equipo?.solicitar_presupuesto === 'Si' || equipo?.solicitar_presupuesto === 'No')}>Sin seleccionar</option>
          <option value="Si" selected={equipo?.solicitar_presupuesto === 'Si'}>Sí</option>
          <option value="No" selected={equipo?.solicitar_presupuesto === 'No'}>No</option>
        </select>
      </div>

      <div class="col-12">
        <label class="form-label">Notas (administración)</label>
        <textarea name="notas_administracion" class="form-control" rows="3">{equipo?.notas_administracion ?? ''}</textarea>
      </div>

      {isVerificar && (
        <div class="col-12 mt-2">
          <h5 class="mb-2"><i class="bi bi-check2-circle me-2"></i> Aprobación del presupuesto</h5>
          <select name="presupuesto_aprobado" class="form-select">
            <option value="Si" selected={equipo?.presupuesto_aprobado === 'Si'}>Si</option>
            <option value="No" selected={equipo?.presupuesto_aprobado === 'No'}>No</option>
          </select>
        </div>
      )}
    </div>

    <div class="mt-4 text-end">
      <button type="submit" class="btn btn-primary">
        <i class="bi bi-save me-1"></i> Guardar cambios
      </button>
    </div>
  </div>
</form>

<script>
(function(){
  function digitsToInt(s){
    if(!s) return 0;
    const d = s.replace(/[^\d]/g,'');
    return Number(d)||0;
  }
  function formatARS(n){
    return new Intl.NumberFormat('es-AR',{
      style:'currency',currency:'ARS',
      minimumFractionDigits:0, maximumFractionDigits:0
    }).format(n);
  }
  function onBlur(e){
    const n = digitsToInt(e.target.value);
    e.target.value = n ? formatARS(n) : '';
  }
  function onInput(e){
    e.target.value = e.target.value.replace(/[^\d]/g,'');
  }
  document.querySelectorAll('.currency-ars').forEach(el=>{
    el.addEventListener('blur', onBlur);
    el.addEventListener('input', onInput);
  });
})();
</script>
