---
import Sidebar from '../components/Sidebar.astro';
---

<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>Repuestos</title>
    <link rel="icon" href="/logo_icono.ico" sizes="any">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />
    <style>
      :root { --sidebar-w: 240px; }
      @media (min-width: 768px) { .page { margin-left: var(--sidebar-w); } }
      .page { padding: 24px; background:#f7f7f9; }
      .content { max-width: 1200px; margin: 0 auto; }

      .table-wrap { max-height: 520px; overflow: auto; border-top: 1px solid #dee2e6; }
      .table thead th { position: sticky; top: 0; background: #f8f9fa; z-index: 2; }
      .table tbody tr:hover td { background: #f5f7fb; }
      .table .col-id { position: sticky; left: 0; background: #fff; z-index: 3; }

      th, td { vertical-align: middle; }
      th.col-id, td.col-id { width: 90px; text-align: right; }
      th.col-acciones, td.col-acciones { width: 96px; text-align: right; }

      .th-sortable { cursor: pointer; user-select: none; white-space: nowrap; }
      .th-sortable .arrow { opacity: .6; margin-left: .25rem; }
      .th-sortable.active { font-weight: 600; }
      .th-sortable:not(.active) .arrow { opacity: .2; }

      .actions { opacity: .0; transition: opacity .15s ease; white-space: nowrap; }
      tbody tr:hover .actions { opacity: 1; }
      .actions .btn { padding: .15rem .4rem; line-height: 1; }

      .toolbar { gap: .5rem; flex-wrap: wrap; }
      .toolbar .form-control, .toolbar .form-select { min-width: 220px; }

      #btnSubmit { background: #0d6efd; border-color: #0d6efd; }
      #btnCancel { display:none; }
      .editing #btnSubmit { background:#198754; border-color:#198754; }
      .editing #btnCancel { display:inline-block; }

      #status { font-size: .9rem; }
      #status.ok { color: #198754; }
      #status.err { color: #dc3545; }
      #status.info { color: #6c757d; }
    </style>
  </head>
  <body>
    <Sidebar />
    <main class="page">
      <div class="content">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <h1 class="h3 mb-0"><i class="bi bi-box-seam"></i> Repuestos</h1>
        </div>

        <!-- ====== Formulario de creación/edición ====== -->
        <div class="card mb-3" id="cardForm">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span id="formTitle">Crear repuesto</span>
            <small class="text-muted" id="formHint"></small>
          </div>
          <div class="card-body">
            <form id="repuestoForm" class="row g-3">
              <input type="hidden" name="id" />
              <div class="col-12 col-md-6">
                <label class="form-label">Componente</label>
                <input required name="componente" type="text" class="form-control" />
              </div>
              <div class="col-6 col-md-3">
                <label class="form-label">Stock</label>
                <input name="stock" type="text" class="form-control" />
              </div>
              <div class="col-6 col-md-3">
                <label class="form-label">Categoría</label>
                <input name="categoria" type="text" class="form-control" />
              </div>
              <div class="col-6 col-md-3">
                <label class="form-label">Precio</label>
                <input name="precio" type="text" class="form-control" placeholder="$0" />
              </div>
              <div class="col-6 col-md-3">
                <label class="form-label">Activo</label>
                <select name="activo" class="form-select">
                  <option value="true">Sí</option>
                  <option value="false">No</option>
                </select>
              </div>
              <div class="col-12 d-flex gap-2 align-items-center">
                <button type="button" id="btnSubmit"  class="btn btn-primary">
                  <i class="bi bi-check2-circle"></i> <span id="btnSubmitText">Crear</span>
                </button>
                <button type="button" id="btnCancel" class="btn btn-outline-secondary">
                  <i class="bi bi-x-circle"></i> Cancelar edición
                </button>
                <span id="status" class="ms-2"></span>
              </div>
            </form>
          </div>
        </div>

        <!-- ====== Toolbar de búsqueda/filtros ====== -->
        <div class="card mb-4">
          <div class="card-body toolbar">
            <div class="row g-2">
              <div class="col-12">
                <div class="input-group">
                  <span class="input-group-text" title="Buscar por nombre de componente">
                    <i class="bi bi-search"></i>
                  </span>
                  <input id="q" type="text" class="form-control" placeholder="Buscar componente..." aria-label="Buscar componente" />
                  <button id="btnClearQ" class="btn btn-outline-secondary" type="button" title="Limpiar búsqueda" style="display:none;">
                    <i class="bi bi-x-lg"></i>
                  </button>
                </div>
              </div>
              <div class="col-6 col-md-6">
                <select id="categoria" class="form-select" title="Filtrar por categoría">
                  <option value="">Todas las categorías</option>
                </select>
              </div>
              <div class="col-6 col-md-6">
                <select id="estado" class="form-select" title="Filtrar por estado">
                  <option value="">Todos los estados</option>
                  <option value="activo">Estado activo</option>
                  <option value="inactivo">No activo</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <!-- ====== Tabla de resultados ====== -->
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>Listado</span>
            <span class="text-muted small" id="resumen"></span>
          </div>
          <div class="table-wrap">
            <table class="table table-sm table-striped mb-0">
              <thead class="table-light">
                <tr>
                  <th class="col-id th-sortable" data-field="id"><span>ID</span><i class="arrow bi"></i></th>
                  <th class="th-sortable" data-field="componente"><span>Componente</span><i class="arrow bi"></i></th>
                  <th class="th-sortable" data-field="stock"><span>Stock</span><i class="arrow bi"></i></th>
                  <th class="th-sortable" data-field="categoria"><span>Categoría</span><i class="arrow bi"></i></th>
                  <th class="th-sortable" data-field="precio"><span>Precio</span><i class="arrow bi"></i></th>
                  <th class="th-sortable" data-field="activo"><span>Activo</span><i class="arrow bi"></i></th>
                  <th class="th-sortable" data-field="actualizado_en"><span>Actualizado</span><i class="arrow bi"></i></th>
                  <th class="col-acciones"></th>
                </tr>
              </thead>
              <tbody id="tbody-repuestos">
                <tr><td colspan="8" class="text-center py-3">Cargando...</td></tr>
              </tbody>
            </table>
          </div>
          <div class="card-footer d-flex justify-content-between align-items-center">
            <div>
              <button class="btn btn-outline-secondary btn-sm" id="prevPage"><i class="bi bi-chevron-left"></i> Anterior</button>
              <button class="btn btn-outline-secondary btn-sm ms-2" id="nextPage">Siguiente <i class="bi bi-chevron-right"></i></button>
            </div>
            <div id="paginacionInfo" class="text-muted small"></div>
          </div>
        </div>
      </div>
    </main>

    <script type="module">
      /* ---------- Refs ---------- */
      const q = document.getElementById('q');
      const btnClearQ = document.getElementById('btnClearQ');
      const categoria = document.getElementById('categoria');
      const estado = document.getElementById('estado');
      const tbody = document.getElementById('tbody-repuestos');
      const resumen = document.getElementById('resumen');
      const paginacionInfo = document.getElementById('paginacionInfo');
      const prevPageBtn = document.getElementById('prevPage');
      const nextPageBtn = document.getElementById('nextPage');

      const cardForm = document.getElementById('cardForm');
      const form = document.getElementById('repuestoForm');
      const statusEl = document.getElementById('status');
      const btnSubmit  = document.getElementById('btnSubmit');
      const btnSubmitText = document.getElementById('btnSubmitText');
      const btnCancel = document.getElementById('btnCancel');
      const formTitle = document.getElementById('formTitle');
      const formHint = document.getElementById('formHint');

      const thSortables = Array.from(document.querySelectorAll('.th-sortable'));

      /* ---------- Estado ---------- */
      let page = 1;
      const pageSize = 30;
      let sortBy = 'id';
      let sortDir = 'asc';

      /* ---------- Helpers ---------- */
      const debounce = (fn, ms=250) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; };
      function toggleClearBtn() {
        btnClearQ?.style && (btnClearQ.style.display = (q?.value ?? '').trim() ? 'block' : 'none');
      }
      function setStatus(text = '', kind = 'info', ms = 2200) {
        statusEl.classList.remove('ok','err','info');
        if (!text) { statusEl.textContent = ''; return; }
        statusEl.textContent = text;
        statusEl.classList.add(kind);
        if (window._statusTimer) clearTimeout(window._statusTimer);
        window._statusTimer = setTimeout(() => {
          statusEl.textContent = '';
          statusEl.classList.remove('ok','err','info');
          window._statusTimer = null;
        }, ms);
      }
      function esc(s) {
        return String(s ?? '')
          .replaceAll('&','&amp;')
          .replaceAll('<','&lt;')
          .replaceAll('>','&gt;')
          .replaceAll('"','&quot;')
          .replaceAll("'",'&#39;');
      }
      function setLoadingRows() {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center py-3">Cargando...</td></tr>';
        setStatus('');
      }
      function updateSortUI() {
        thSortables.forEach(th => {
          const field = th.getAttribute('data-field');
          const arrow = th.querySelector('.arrow');
          const active = field === sortBy;
          th.classList.toggle('active', active);
          if (arrow) {
            arrow.className = 'arrow bi ' + (active
              ? (sortDir === 'asc' ? 'bi-arrow-up' : 'bi-arrow-down')
              : 'bi-arrow-down');
          }
        });
      }

      /* ---------- Cargar ---------- */
      async function cargar() {
        setLoadingRows();
        try {
          const params = new URLSearchParams({
            page: String(page),
            pageSize: String(pageSize),
            q: (q?.value ?? '').trim(),
            categoria: (categoria?.value ?? '').trim(),
            estado: (estado?.value ?? '').trim(),
            sortBy,
            sortDir,
          });

          const res = await fetch('/api/listarRepuestos?' + params.toString());
          const out = await res.json().catch(() => ({}));
          if (!res.ok) throw new Error(out?.error || `HTTP ${res.status}`);

          const data = out.rows || [];
          const total = out.total || 0;

          const maxPage = total ? Math.ceil(total / pageSize) : 1;
          if (total > 0 && page > maxPage) { page = maxPage; return cargar(); }

          if (!Array.isArray(data) || data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-muted">Sin resultados.</td></tr>';
          } else {
            tbody.innerHTML = data.map(r => `
              <tr data-id="${r.id}" style="cursor:pointer">
                <td class="col-id">${r.id}</td>
                <td>${esc(r.componente)}</td>
                <td>${esc(r.stock)}</td>
                <td>${esc(r.categoria)}</td>
                <td>${esc(r.precio)}</td>
                <td>${r.activo ? 'Sí' : 'No'}</td>
                <td>${esc(r.actualizado_en)}</td>
                <td class="col-acciones">
                  <div class="actions">
                    <button class="btn btn-outline-primary btn-sm btn-row-editar" title="Editar"><i class="bi bi-pencil-square"></i></button>
                    <button class="btn btn-outline-danger  btn-sm btn-row-borrar"  title="Borrar"><i class="bi bi-trash"></i></button>
                  </div>
                </td>
              </tr>
            `).join('');
          }

          const from = total ? (page - 1) * pageSize + 1 : 0;
          const to = total ? Math.min(page * pageSize, total) : 0;
          resumen.textContent = total ? `Total: ${total}` : '';
          paginacionInfo.textContent = total ? `Mostrando ${from}-${to} de ${total}` : '';
          prevPageBtn.disabled = page <= 1;
          nextPageBtn.disabled = (page * pageSize) >= total;

          updateSortUI();
        } catch (e) {
          console.error(e);
          tbody.innerHTML = '<tr><td colspan="8" class="text-danger text-center py-3">Error al cargar.</td></tr>';
          resumen.textContent = '';
          paginacionInfo.textContent = '';
          setStatus('Error al cargar: ' + (e?.message || 'desconocido'), 'err', 4500);
        }
      }

      /* ---------- Categorías (auto-aplica si cambia la selección) ---------- */
      async function cargarCategorias(keepSelected = true) {
        const selectedBefore = keepSelected ? (categoria?.value ?? '') : '';
        const prevValue = categoria.value ?? '';
        try {
          const res = await fetch('/api/categoriasRepuestos');
          const out = await res.json();
          const cats = Array.isArray(out?.categorias) ? out.categorias : [];

          categoria.innerHTML = '';
          const defaultOpt = document.createElement('option');
          defaultOpt.value = '';
          defaultOpt.textContent = 'Todas las categorías';
          categoria.appendChild(defaultOpt);
          for (const c of cats) {
            const opt = document.createElement('option');
            opt.value = c;
            opt.textContent = c;
            categoria.appendChild(opt);
          }

          const newValue = (keepSelected && selectedBefore && cats.includes(selectedBefore)) ? selectedBefore : '';
          const changed = prevValue !== newValue;
          categoria.value = newValue;

          // si cambió la selección efectiva (por ejemplo, desapareció la única categoría) => aplicar YA
          if (changed) { page = 1; await cargar(); }
          return categoria.value;
        } catch (e) {
          console.error('No se pudieron cargar categorías', e);
          const changed = (categoria.value ?? '') !== '';
          categoria.innerHTML = '<option value="">Todas las categorías</option>';
          categoria.value = '';
          if (changed) { page = 1; await cargar(); }
          return '';
        }
      }

      /* ---------- Orden por encabezado ---------- */
      thSortables.forEach(th => {
        th.addEventListener('click', () => {
          const field = th.getAttribute('data-field');
          if (!field) return;
          if (sortBy === field) sortDir = (sortDir === 'asc') ? 'desc' : 'asc';
          else { sortBy = field; sortDir = 'asc'; }
          page = 1;
          cargar(); // auto-aplica
        });
      });

      /* ---------- Listeners (auto-aplican) ---------- */
      const autoSearch = debounce(() => { page = 1; cargar(); }, 250);
      q?.addEventListener('input', () => { toggleClearBtn(); autoSearch(); });
      q?.addEventListener('keydown', (e) => { if (e.key === 'Enter') e.preventDefault(); });
      toggleClearBtn();
      btnClearQ?.addEventListener('click', () => {
        q.value = '';
        toggleClearBtn();
        page = 1;
        cargar();
      });

      categoria?.addEventListener('change', () => { page = 1; cargar(); });
      estado?.addEventListener('change',   () => { page = 1; cargar(); });

      prevPageBtn?.addEventListener('click', () => { if (page>1) { page--; cargar(); } });
      nextPageBtn?.addEventListener('click', () => { page++; cargar(); } );

      /* ---------- Editar / Borrar ---------- */
      tbody.addEventListener('click', async (e) => {
        const btnEdit = e.target.closest('.btn-row-editar');
        const btnDel  = e.target.closest('.btn-row-borrar');
        const tr = e.target.closest('tr[data-id]');
        if (!tr) return;

        const idStr = tr.dataset.id || '';
        const idNum = Number(idStr);
        if (!idNum) { setStatus('ID inválido', 'err', 2500); return; }

        const tds = tr.querySelectorAll('td');

        // EDITAR
        if (btnEdit) {
          form.elements['id'].value           = String(idNum);
          form.elements['componente'].value   = tds[1].textContent.trim();
          form.elements['stock'].value        = tds[2].textContent.trim();
          form.elements['categoria'].value    = tds[3].textContent.trim();
          form.elements['precio'].value       = tds[4].textContent.trim();
          form.elements['activo'].value       = (tds[5].textContent.includes('Sí')).toString();
          cardForm.classList.add('editing');
          btnSubmitText.textContent = 'Guardar cambios';
          formTitle.textContent = 'Editar repuesto';
          formHint.textContent = `ID #${idNum}`;
          document.getElementById('cardForm').scrollIntoView({ behavior: 'smooth', block: 'start' });
          form.elements['componente'].focus();
          return;
        }

        // BORRAR
        if (btnDel) {
          if (!confirm(`¿Borrar repuesto #${idNum}?`)) return;
          try {
            const res = await fetch('/api/borrarRepuesto', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ id: idNum }),
            });
            const out = await res.json().catch(() => ({}));
            if (!res.ok || !out.ok) {
              throw new Error(out?.error || `No se pudo borrar (HTTP ${res.status})`);
            }

            // si estaba editándose este ID, salir de edición
            if (String(form.elements['id'].value || '') === String(idNum)) setCreateMode();

            // 1) reconstruir categorías primero (si desaparece la única, queda "todas" y auto-aplica)
            await cargarCategorias(false);

            // 2) limpiar búsqueda/estado y recargar (auto)
            q.value = '';
            toggleClearBtn();
            estado.value = '';
            page = 1;
            await cargar();

            setStatus(out.mode === 'hard' ? 'Borrado ✔'
                    : out.mode === 'soft_linked' ? 'Desactivado (usado en presupuestos) ✔'
                    : 'Desactivado ✔', 'ok');
          } catch (err) {
            console.error(err);
            setStatus('No se pudo borrar', 'err', 2500);
          }
        }
      });

      /* ---------- Guardar ---------- */
      const precioInput = form.elements['precio'];
      function formatPrecioVisual(raw) {
        const digits = String(raw ?? '').replace(/[^\d]/g, '');
        if (!digits) return '';
        const pesos = Number(digits);
        const numero = new Intl.NumberFormat('es-AR', { minimumFractionDigits: 0, maximumFractionDigits: 0 })
          .format(pesos).replace(/\s/g, '');
        return '$' + numero;
      }
      precioInput.addEventListener('blur', () => { precioInput.value = formatPrecioVisual(precioInput.value); });

      function setCreateMode() {
        form.reset();
        cardForm.classList.remove('editing');
        btnSubmitText.textContent = 'Crear';
        formTitle.textContent = 'Crear repuesto';
        formHint.textContent = '';
        form.elements['id'].value = '';
        setStatus('');
      }

      function getPayloadFromForm(requireId=false) {
        const fd = new FormData(form);
        const idStr = String(fd.get('id') || '').trim();
        const id = idStr ? Number(idStr) : undefined;
        if (requireId && !id) throw new Error('Seleccioná un repuesto (clic en una fila)');
        return {
          id,
          componente: String(fd.get('componente') || '').trim(),
          stock: String(fd.get('stock') || '').trim() || null,
          categoria: String(fd.get('categoria') || '').trim() || null,
          precio: String(fd.get('precio') || '').trim() || null,
          activo: String(fd.get('activo')) === 'true',
        };
      }

      btnSubmit.addEventListener('click', async () => {
        const editando = !!form.elements['id'].value;
        btnSubmit.disabled = true;
        try {
          const p = getPayloadFromForm(editando);
          if (!editando) delete p.id;
          const res = await fetch('/api/actualizarRepuesto', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(p),
          });
          const out = await res.json();
          if (!res.ok) throw new Error(out?.error || 'Error');
          setCreateMode();

          // refrescar categorías (mantener selección si existe) y lista
          await cargarCategorias(true);
          await cargar();

          setStatus(editando ? 'Guardado ✔' : 'Creado ✔', 'ok');
        } catch (e) {
          console.error(e);
          setStatus('Error al guardar', 'err', 2500);
        } finally {
          btnSubmit.disabled = false;
        }
      });

      btnCancel.addEventListener('click', () => setCreateMode());

      // Init (categorías -> lista) — cargarCategorias auto-aplica si cambia la selección
      setCreateMode();
      await cargarCategorias(false);
      updateSortUI();
      page = 1;
      await cargar();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
