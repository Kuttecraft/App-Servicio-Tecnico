---
import BasePrivateLayout from '../layouts/BasePrivateLayout.astro';

const perfil = (Astro.locals as any)?.perfil || {};
const email: string | undefined = perfil?.email || (Astro.locals as any)?.user?.email;
if (!email) {
  return Astro.redirect('/no-autorizado');
}
const tecnicoLocal = String(email).split('@')[0].toLowerCase();

const now = new Date();
const yyyy = now.getFullYear();
const mm = String(now.getMonth() + 1).padStart(2, '0');
const defaultMonth = `${yyyy}-${mm}`;
---

<BasePrivateLayout>
  <div class="container mt-4" style="max-width: 1200px;"> <!-- ⬆️ más ancho -->
    <!-- Header -->
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-3 mb-4">
      <h1 class="h5 m-0">Mis estadísticas (técnico)</h1>
      <div class="d-flex align-items-center gap-2 flex-wrap">
        <label for="mes" class="form-label m-0">Mes</label>
        <input id="mes" type="month" class="form-control" style="min-width: 200px;" value={defaultMonth} />
        <button id="btn-actualizar" class="btn btn-primary">Actualizar</button>
      </div>
    </div>

    <!-- Card -->
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <h2 class="h6 text-muted m-0">Técnico: <code>{tecnicoLocal}</code></h2>
          <div id="badge-reparadas"
               class="badge bg-success-subtle text-success border border-success-subtle px-3 py-2"
               style="font-size:.9rem;">
            Cargando…
          </div>
        </div>

        <div id="sin-datos" class="alert alert-warning d-none">No hay datos para mostrar.</div>

        <div class="table-responsive">
          <table class="table table-sm table-striped table-hover table-compact align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th class="col-id">ID / Cliente</th>
                <th style="width: 20%;">Modelo</th>
                <th class="d-none d-sm-table-cell" style="width:12%;">Estado</th>
                <th class="col-date d-none d-md-table-cell" style="width:12%;">Fecha presupuesto</th>
                <th class="col-date d-none d-md-table-cell" style="width:12%;">Fecha lista</th>
                <th class="col-num text-end" style="width:10%;">Tardanza (días)</th>
                <th class="col-check text-center" style="width:8%;">¿Reparada?</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <footer id="footer" class="mt-3 pt-3 border-top small">
          <strong>Pie de página:</strong>
          &nbsp;Total de <em>impresoras</em> reparadas por <code>{tecnicoLocal}</code>:
          <strong id="total-reparadas"> 0</strong>
        </footer>
      </div>
    </div>
  </div>

  <style is:inline>
    /* --- Layout general --- */
    code { background:#f6f8fa; padding:.1rem .35rem; border-radius:.25rem; }
    .badge { padding:.35rem .6rem; }

    /* --- Tabla más cómoda --- */
    .table-compact :is(th,td) {
      padding:.55rem .7rem;
      vertical-align: middle;
    }
    .table thead th {
      font-weight:600;
      white-space: nowrap;
    }
    .col-id{ white-space:nowrap; width:1%; }
    .col-date{ font-variant-numeric: tabular-nums; white-space:nowrap; }
    .col-num{ font-variant-numeric: tabular-nums; }
    .col-check{ width:6rem; text-align:center; }

    /* --- Chip ID + cliente --- */
    .id-cell { white-space: nowrap; }
    .id-chip {
      font-variant-numeric: tabular-nums;
      margin-right: .35rem;
    }
    .cliente-badge {
      font-size: .75rem;
      border: 1px solid rgba(0,0,0,.08);
      background:#f8f9fa;
      color:#333;
    }
    .id-wrap{ gap:.35rem; display:inline-flex; align-items:center; }

    @media (max-width: 768px) {
      .id-wrap { flex-direction: column; align-items: flex-start; gap:.25rem; }
    }
  </style>

  <script is:inline data-tecnico={tecnicoLocal}>
    (function () {
      const tecnico = (document.currentScript?.dataset?.tecnico || '').toString();

      async function cargar() {
        try {
          const url = `/api/estadisticas-tecnico?tecnico=${encodeURIComponent(tecnico)}&all=true`;
          const res = await fetch(url);
          if (!res.ok) throw new Error('Error consultando estadísticas del técnico');
          const data = await res.json();

          const $tbody = document.getElementById('tbody');
          const $sin = document.getElementById('sin-datos');
          const $badge = document.getElementById('badge-reparadas');
          const $totalFooter = document.getElementById('total-reparadas');
          $tbody.innerHTML = '';

          if (!data.items || !data.items.length) {
            $sin.classList.remove('d-none');
            $badge.textContent = '0 reparadas';
            $totalFooter.textContent = ' 0';
            return;
          } else {
            $sin.classList.add('d-none');
          }

          data.items.forEach((r) => {
            const tr = document.createElement('tr');
            const cliente = (r.cliente || '—').toString();
            const tardanza = (typeof r.tardanza_dias === 'number') ? r.tardanza_dias : '—';

            tr.innerHTML = `
              <td class="id-cell">
                <div class="id-wrap">
                  <a class="id-chip fw-semibold text-decoration-none" href="/detalle/${r.id}" title="Ver ticket ${r.id}">${r.id}</a>
                  <span class="badge bg-light text-dark cliente-badge" title="Cliente">${cliente}</span>
                </div>
              </td>
              <td>${r.modelo}</td>
              <td class="d-none d-sm-table-cell">${r.estado}</td>
              <td class="d-none d-md-table-cell">${r.fecha_presupuesto || '—'}</td>
              <td class="d-none d-md-table-cell">${r.fecha_lista || '—'}</td>
              <td class="text-end">${tardanza}</td>
              <td class="text-center">${r.reparada ? '✅' : '—'}</td>
            `;
            $tbody.appendChild(tr);
          });

          const totalRep = data.totalImpresorasReparadas || 0;
          $badge.textContent = totalRep + ' reparada' + (totalRep === 1 ? '' : 's');
          $totalFooter.textContent = ' ' + totalRep;
        } catch (e) {
          console.error(e);
          document.getElementById('sin-datos').classList.remove('d-none');
        }
      }

      document.getElementById('btn-actualizar')?.addEventListener('click', cargar);
      document.getElementById('mes')?.addEventListener('change', cargar);
      window.addEventListener('DOMContentLoaded', cargar);
    })();
  </script>
</BasePrivateLayout>
