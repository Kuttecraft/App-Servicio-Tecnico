---
import BasePrivateLayout from '../../layouts/BasePrivateLayout.astro';
import { supabase } from '../../lib/supabase';

interface EquipoCompleto {
  id: number;
  ticket: number;
  estado: string;
  marca_temporal: string | null;
  fecha_de_reparacion: string | null;
  tecnico_id: number | null;
  cliente_id: number;
  impresora_id: number | null;
  imagen: string | null;
  imagen_ticket: string | null;
  imagen_extra: string | null;
  notas_del_tecnico: string | null;

  cliente?: {
    dni_cuit: string | null;
    correo_electronico: string | null;
    whatsapp: string | null;
    comentario: string | null;
  };

  tecnicos?: { nombre: string; apellido: string };
  impresoras?: { modelo: string };
  delivery?: { pagado: string; cotizar_delivery: string; informacion_adicional_delivery: string };
  presupuestos?: { monto: string; link_presupuesto: string; cubre_garantia: string; fecha_presupuesto: string };
}

const { id } = Astro.params;

const { data } = await supabase
  .from('tickets_mian')
  .select(`
    id, ticket, estado, marca_temporal, fecha_de_reparacion, tecnico_id, cliente_id, impresora_id, imagen, imagen_ticket, imagen_extra, notas_del_tecnico,
    cliente:cliente_id (dni_cuit, correo_electronico, whatsapp, comentario),
    tecnicos:tecnico_id (nombre, apellido),
    impresoras:impresora_id (modelo),
    delivery (pagado, cotizar_delivery, informacion_adicional_delivery),
    presupuestos (monto, link_presupuesto, cubre_garantia, fecha_presupuesto)
  `)
  .eq('id', id)
  .maybeSingle();

const equipo = {
  ...data,
  cliente: Array.isArray(data?.cliente) ? data?.cliente[0] : data?.cliente,
  tecnicos: Array.isArray(data?.tecnicos) ? data?.tecnicos[0] : data?.tecnicos,
  impresoras: Array.isArray(data?.impresoras) ? data?.impresoras[0] : data?.impresoras,
  delivery: Array.isArray(data?.delivery) ? data?.delivery[0] : data?.delivery,
  presupuestos: Array.isArray(data?.presupuestos) ? data?.presupuestos[0] : data?.presupuestos,
} as EquipoCompleto;
---

<BasePrivateLayout>
  <div class="container mt-4">
    <h1 class="h3 mb-4">Editar equipo</h1>

    {equipo ? (
      <form
        method="POST"
        action={`/api/actualizarTicket?id=${equipo.id}`}
        enctype="multipart/form-data"
        class="card p-4 shadow-sm"
        style="max-width: 900px; margin: auto;"
        id="form-editar-equipo"
      >
        <div class="row g-3">
          {/* Campos principales */}
          <div class="col-md-6">
            <label class="form-label">Estado</label>
            <input name="estado" type="text" class="form-control" value={equipo.estado} />
          </div>

          <div class="col-md-6">
            <label class="form-label">Modelo</label>
            <input name="modelo" type="text" class="form-control" value={equipo.impresoras?.modelo || ''} />
          </div>

          <div class="col-md-6">
            <label class="form-label">Fecha formulario</label>
            <input name="fechaFormulario" type="date" class="form-control" value={equipo.marca_temporal?.slice(0, 10)} />
          </div>

          <div class="col-md-6">
            <label class="form-label">Técnico</label>
            <input name="tecnico" type="text" class="form-control" value={`${equipo.tecnicos?.nombre || ''} ${equipo.tecnicos?.apellido || ''}`} />
          </div>

          <div class="col-md-12">
            <label class="form-label">Nota Técnico</label>
            <textarea name="notaTecnico" class="form-control">{equipo.notas_del_tecnico || ''}</textarea>
          </div>

          <div class="col-md-12">
            <label class="form-label">Comentarios</label>
            <textarea name="comentarios" class="form-control">{equipo.cliente?.comentario || ''}</textarea>
          </div>

          <div class="col-md-6">
            <label class="form-label">¿Cubre garantía?</label>
            <select name="cubreGarantia" class="form-select" value={equipo.presupuestos?.cubre_garantia === 'true' ? 'true' : 'false'}>
              <option value="true">Sí</option>
              <option value="false">No</option>
            </select>
          </div>

          <div class="col-md-6">
            <label class="form-label">¿Cobrado?</label>
            <select name="cobrado" class="form-select" value={equipo.delivery?.pagado === 'true' ? 'true' : 'false'}>
              <option value="true">Sí</option>
              <option value="false">No</option>
            </select>
          </div>

          <div class="col-md-6">
            <label class="form-label">Monto</label>
            <input name="monto" type="number" step="0.01" class="form-control" value={equipo.presupuestos?.monto || ''} />
          </div>

          <div class="col-md-6">
            <label class="form-label">Link presupuesto</label>
            <input name="linkPresupuesto" type="url" class="form-control" value={equipo.presupuestos?.link_presupuesto || ''} />
          </div>

          <div class="col-md-6">
            <label class="form-label">Modo delivery</label>
            <input name="costoDelivery" type="text" class="form-control" value={equipo.delivery?.cotizar_delivery || ''} />
          </div>

          <div class="col-md-6">
            <label class="form-label">Info delivery</label>
            <input name="infoDelivery" type="text" class="form-control" value={equipo.delivery?.informacion_adicional_delivery || ''} />
          </div>

          <div class="col-md-6">
            <label class="form-label">DNI/CUIT</label>
            <input name="dniCuit" type="text" class="form-control" value={equipo.cliente?.dni_cuit || ''} />
          </div>

          <div class="col-md-6">
            <label class="form-label">WhatsApp</label>
            <input name="whatsapp" type="text" class="form-control" value={equipo.cliente?.whatsapp || ''} />
          </div>

          <div class="col-md-12">
            <label class="form-label">Correo</label>
            <input name="correo" type="email" class="form-control" value={equipo.cliente?.correo_electronico || ''} />
          </div>

          <div class="col-md-6">
            <label class="form-label">Fecha presupuesto</label>
            <input name="timestampPresupuesto" type="date" class="form-control" value={equipo.presupuestos?.fecha_presupuesto?.slice(0, 10) || ''} />
          </div>

          <div class="col-md-6">
            <label class="form-label">Fecha listo</label>
            <input name="timestampListo" type="date" class="form-control" value={equipo.fecha_de_reparacion?.slice(0, 10) || ''} />
          </div>

          {/* Imagen equipo (principal) */}
          <div class="col-md-12">
            <h6 class="mt-3">Imagen principal</h6>
            <div class="mb-3 d-flex flex-column align-items-center" style="gap: 1rem;">
              <div class="rounded shadow-sm border overflow-hidden" style="max-width: 320px; max-height: 320px; border-radius: 15px;">
                <img
                  id="img-actual-o-preview"
                  src={equipo.imagen || '/logo.webp'}
                  alt="Imagen actual"
                  class="img-fluid"
                  style="width: 100%; height: 100%; object-fit: cover;"
                  loading="lazy"
                />
              </div>
              <label class="btn btn-primary fw-semibold">
                <i class="bi bi-upload me-2"></i> Cambiar imagen
                <input type="file" name="imagenArchivo" accept="image/*" id="input-imagen-archivo" style="display:none;" />
              </label>
            </div>
            <input type="hidden" name="borrarImagen" id="input-borrar-imagen" value="false" />
            <div class="mt-2 d-flex flex-column flex-md-row gap-2 justify-content-center align-items-stretch">
              <button type="button" class="btn btn-danger order-2 order-md-1 px-4" id="btn-eliminar-equipo">Eliminar imagen</button>
              <button type="submit" class="btn btn-success order-1 order-md-2 px-4">Guardar cambios</button>
            </div>
          </div>

          {/* Imagen de ticket */}
          <div class="col-md-12">
            <h6 class="mt-4">Imagen del ticket</h6>
            <div class="mb-3 d-flex flex-column align-items-center" style="gap: 1rem;">
              <div class="rounded shadow-sm border overflow-hidden" style="max-width: 320px; max-height: 320px; border-radius: 15px;">
                <img
                  id="img-ticket-preview"
                  src={equipo.imagen_ticket || '/logo.webp'}
                  alt="Imagen ticket"
                  class="img-fluid"
                  style="width: 100%; height: 100%; object-fit: cover;"
                  loading="lazy"
                />
              </div>
              <label class="btn btn-primary fw-semibold">
                <i class="bi bi-upload me-2"></i> Cambiar imagen ticket
                <input type="file" name="imagenTicketArchivo" accept="image/*" id="input-imagen-ticket" style="display:none;" />
              </label>
            </div>
            <input type="hidden" name="borrarImagenTicket" id="input-borrar-imagen-ticket" value="false" />
            <div class="mt-2 d-flex flex-column flex-md-row gap-2 justify-content-center align-items-stretch">
              <button type="button" class="btn btn-danger px-4" id="btn-eliminar-imagen-ticket">Eliminar imagen ticket</button>
            </div>
          </div>

          {/* Imagen extra */}
          <div class="col-md-12">
            <h6 class="mt-4">Imagen extra</h6>
            <div class="mb-3 d-flex flex-column align-items-center" style="gap: 1rem;">
              <div class="rounded shadow-sm border overflow-hidden" style="max-width: 320px; max-height: 320px; border-radius: 15px;">
                <img
                  id="img-extra-preview"
                  src={equipo.imagen_extra || '/logo.webp'}
                  alt="Imagen extra"
                  class="img-fluid"
                  style="width: 100%; height: 100%; object-fit: cover;"
                  loading="lazy"
                />
              </div>
              <label class="btn btn-primary fw-semibold">
                <i class="bi bi-upload me-2"></i> Cambiar imagen extra
                <input type="file" name="imagenExtraArchivo" accept="image/*" id="input-imagen-extra" style="display:none;" />
              </label>
            </div>
            <input type="hidden" name="borrarImagenExtra" id="input-borrar-imagen-extra" value="false" />
            <div class="mt-2 d-flex flex-column flex-md-row gap-2 justify-content-center align-items-stretch">
              <button type="button" class="btn btn-danger px-4" id="btn-eliminar-imagen-extra">Eliminar imagen extra</button>
            </div>
          </div>
        </div>
      </form>
    ) : (
      <p class="text-danger">No se encontró el equipo con ID: {id}</p>
    )}
  </div>

  <!-- Compresión (si la usás en tu JS) -->
  <script src="https://unpkg.com/browser-image-compression@latest/dist/browser-image-compression.js" defer></script>

  <!-- Lógica separada para manejar 3 imágenes -->
  <script src="/scripts/form-mas-imagenes.js?v=1" defer></script>
</BasePrivateLayout>
