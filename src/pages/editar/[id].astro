---
import BasePrivateLayout from '../../layouts/BasePrivateLayout.astro';
import { supabase } from '../../lib/supabase';

interface EquipoCompleto {
  id: number;
  ticket: number;
  estado: string;
  marca_temporal: string | null;
  fecha_de_reparacion: string | null;
  tecnico_id: number | null;
  cliente_id: number;
  impresora_id: number | null;
  imagen: string | null;
  notas_del_tecnico: string | null;

  cliente?: {
    dni_cuit: string | null;
    correo_electronico: string | null;
    whatsapp: string | null;
    comentario: string | null;
  };

  tecnicos?: {
    nombre: string;
    apellido: string;
  };

  impresoras?: {
    modelo: string;
  };

  delivery?: {
    pagado: string;
    cotizar_delivery: string;
    informacion_adicional_delivery: string;
  };

  presupuestos?: {
    monto: string;
    link_presupuesto: string;
    cubre_garantia: string;
    fecha_presupuesto: string;
  };
}

const { id } = Astro.params;

// Consulta un ticket y relaciones correctamente tipadas (no como arrays)
const { data, error } = await supabase
  .from('tickets_mian')
  .select(`
    id,
    ticket,
    estado,
    marca_temporal,
    fecha_de_reparacion,
    tecnico_id,
    cliente_id,
    impresora_id,
    imagen,
    notas_del_tecnico,

    cliente:cliente_id (
      dni_cuit,
      correo_electronico,
      whatsapp,
      comentario
    ),
    tecnicos:tecnico_id (
      nombre,
      apellido
    ),
    impresoras:impresora_id (
      modelo
    ),
    delivery (
      pagado,
      cotizar_delivery,
      informacion_adicional_delivery
    ),
    presupuestos (
      monto,
      link_presupuesto,
      cubre_garantia,
      fecha_presupuesto
    )
  `)
  .eq('id', id)
  .maybeSingle();

const equipo = {
  ...data,
  cliente: Array.isArray(data?.cliente) ? data?.cliente[0] : data?.cliente,
  tecnicos: Array.isArray(data?.tecnicos) ? data?.tecnicos[0] : data?.tecnicos,
  impresoras: Array.isArray(data?.impresoras) ? data?.impresoras[0] : data?.impresoras,
  delivery: Array.isArray(data?.delivery) ? data?.delivery[0] : data?.delivery,
  presupuestos: Array.isArray(data?.presupuestos) ? data?.presupuestos[0] : data?.presupuestos,
} as EquipoCompleto;

/* 
//Zona Test
if (error) {
  console.error('❌ Error al consultar Supabase:', error.message);
} else {
  console.log('✅ Datos crudos recibidos desde Supabase:', JSON.stringify(data, null, 2));
}
  
*/

---

<BasePrivateLayout>
  <div class="container mt-4">
    <h1 class="h3 mb-4">Editar equipo</h1>

    {equipo ? (
      <form method="POST" action={`/api/actualizarTicket?id=${equipo.id}`} enctype="multipart/form-data" class="card p-4 shadow-sm" style="max-width: 800px; margin: auto;" id="form-editar-equipo">
        <div class="row g-3">

          {/* Campos principales */}
          <div class="col-md-6">
            <label class="form-label">Estado</label>
            <input name="estado" type="text" class="form-control" value={equipo.estado} />
          </div>

          <div class="col-md-6">
            <label class="form-label">Modelo</label>
            <input name="modelo" type="text" class="form-control" value={equipo.impresoras?.modelo || ''} />
          </div>

          <div class="col-md-6">
            <label class="form-label">Fecha formulario</label>
            <input name="fechaFormulario" type="date" class="form-control" value={equipo.marca_temporal?.slice(0, 10)} />
          </div>

          <div class="col-md-6">
            <label class="form-label">Técnico</label>
            <input name="tecnico" type="text" class="form-control" value={`${equipo.tecnicos?.nombre || ''} ${equipo.tecnicos?.apellido || ''}`} />
          </div>

          <div class="col-md-12">
            <label class="form-label">Nota Técnico</label>
            <textarea name="notaTecnico" class="form-control">{equipo.notas_del_tecnico || ""}</textarea>
          </div>

          <div class="col-md-12">
            <label class="form-label">Comentarios</label>
            <textarea name="comentarios" class="form-control">{equipo.cliente?.comentario || ''}</textarea>
          </div>

          <div class="col-md-6">
            <label class="form-label">¿Cubre garantía?</label>
            <select name="cubreGarantia" class="form-select">
              <option value="true" selected={equipo.presupuestos?.cubre_garantia === 'true'}>Sí</option>
              <option value="false" selected={equipo.presupuestos?.cubre_garantia !== 'true'}>No</option>
            </select>
          </div>

          <div class="col-md-6">
            <label class="form-label">¿Cobrado?</label>
            <select name="cobrado" class="form-select">
              <option value="true" selected={equipo.delivery?.pagado === 'true'}>Sí</option>
              <option value="false" selected={equipo.delivery?.pagado !== 'true'}>No</option>
            </select>
          </div>

          <div class="col-md-6">
            <label class="form-label">Monto</label>
            <input name="monto" type="number" step="0.01" class="form-control" value={equipo.presupuestos?.monto || ''} />
          </div>

          <div class="col-md-6">
            <label class="form-label">Link presupuesto</label>
            <input name="linkPresupuesto" type="url" class="form-control" value={equipo.presupuestos?.link_presupuesto || ''} />
          </div>

          <div class="col-md-6">
            <label class="form-label">Modo delivery</label>
            <input name="costoDelivery" type="text" class="form-control" value={equipo.delivery?.cotizar_delivery || ''} />
          </div>

          <div class="col-md-6">
            <label class="form-label">Info delivery</label>
            <input name="infoDelivery" type="text" class="form-control" value={equipo.delivery?.informacion_adicional_delivery || ''} />
          </div>

          <div class="col-md-6">
            <label class="form-label">DNI/CUIT</label>
            <input name="dniCuit" type="text" class="form-control" value={equipo.cliente?.dni_cuit || ''} />
          </div>

          <div class="col-md-6">
            <label class="form-label">WhatsApp</label>
            <input name="whatsapp" type="text" class="form-control" value={equipo.cliente?.whatsapp || ''} />
          </div>

          <div class="col-md-12">
            <label class="form-label">Correo</label>
            <input name="correo" type="email" class="form-control" value={equipo.cliente?.correo_electronico || ''} />
          </div>

          <div class="col-md-6">
            <label class="form-label">Fecha presupuesto</label>
            <input name="timestampPresupuesto" type="date" class="form-control" value={equipo.presupuestos?.fecha_presupuesto?.slice(0, 10) || ''} />
          </div>

          <div class="col-md-6">
            <label class="form-label">Fecha listo</label>
            <input name="timestampListo" type="date" class="form-control" value={equipo.fecha_de_reparacion?.slice(0, 10) || ''} />
          </div>

          {/* Imagen equipo: muestra actual y reemplazo */}
          <div class="col-md-12">
            <div class="mb-4 d-flex flex-column align-items-center" id="imagen-actual-container" style="gap: 1rem;">
              <div class="position-relative" style="width: 240px; height: 240px;">
                <img
                  id="img-actual-o-preview"
                  src={equipo.imagen ? equipo.imagen + '?t=' + Date.now() : '/logo.webp'}
                  alt="Imagen actual"
                  class="shadow-sm border"
                  style="width: 100%; height: 100%; object-fit: cover; border-radius: 10px; transition: box-shadow .2s;"
                />
              </div>

              {/* Botón custom de upload */}
              <label class="btn-upload-image mt-3 fw-semibold">
                <i class="bi bi-upload me-2"></i> Cambiar imagen
                <input type="file" name="imagenArchivo" accept="image/*" id="input-imagen-archivo" />
              </label>
            </div>

            <input type="hidden" name="borrarImagen" id="input-borrar-imagen" value="false" />

            {/* Botones */}
            <div class="mt-4 d-flex flex-column flex-md-row gap-2 justify-content-center align-items-stretch">
              <button type="submit" class="btn btn-success order-1 order-md-2 px-4">Guardar cambios</button>
              <button type="button" class="btn btn-danger order-3 order-md-1 px-4" id="btn-eliminar-equipo">Eliminar imagen</button>
            </div>
          </div>
        </div>
      </form>
    ) : (
      <p class="text-danger">No se encontró el equipo con ID: {id}</p>
    )}
  </div>

  <script src="https://unpkg.com/browser-image-compression@latest/dist/browser-image-compression.js"></script>
  <script src="/scripts/form-editar-equipo.js" is:inline></script>
</BasePrivateLayout>
