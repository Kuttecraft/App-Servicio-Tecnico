---
import BasePrivateLayout from '../../layouts/BasePrivateLayout.astro';
import { supabase } from '../../lib/supabase';
import { formatearFecha, booleanATexto } from '../../lib/utils';

const { id } = Astro.params as { id: string };

type Perfil = { rol?: string; admin?: boolean; activo?: boolean };
const perfil = (Astro.locals as any).perfil as Perfil | undefined;
const isAdmin = (perfil?.rol === 'admin') || (perfil?.admin === true);
const isTecnico = perfil?.rol === 'tecnico';

// Ticket + joins
const { data, error } = await supabase
  .from('tickets_mian')
  .select(`
    *,
    cliente:cliente_id ( dni_cuit, correo_electronico, whatsapp, cliente ),
    tecnico:tecnico_id ( nombre, apellido ),
    delivery ( pagado ),
    impresoras:impresora_id ( modelo, maquina, numero_de_serie, tamano_de_boquilla )
  `)
  .eq('id', id)
  .single();

const equipo = data;

const impresora = Array.isArray((equipo as any)?.impresoras)
  ? (equipo as any).impresoras?.[0]
  : (equipo as any)?.impresoras;

const modeloMostrado =
  (impresora?.modelo && String(impresora?.modelo).trim()) ||
  (equipo?.maquina_reparada && String(equipo?.maquina_reparada).trim()) ||
  'Modelo no especificado';

const imagenPrincipal =
  equipo?.imagen_ticket || equipo?.imagen || equipo?.imagen_extra || '/logo.webp';

const imagenes: string[] = Array.from(new Set(
  [equipo?.imagen_ticket, equipo?.imagen, equipo?.imagen_extra].filter(Boolean) as string[]
));

// ¿Existe presupuesto?
const { data: presupuestoExistente } = await supabase
  .from('presupuestos')
  .select('id')
  .eq('ticket_id', id)
  .maybeSingle();

const hasPresupuesto = Boolean(presupuestoExistente?.id);

// ¿Existe delivery?
const { data: deliveryExistente } = await supabase
  .from('delivery')
  .select('id')
  .eq('ticket_id', id)
  .maybeSingle();

const hasDelivery = Boolean(deliveryExistente?.id);
---

<BasePrivateLayout>
  <style>
    .thumbs { display: flex; gap: .5rem; justify-content: center; }
    .thumb { height: 60px; width: 60px; border-radius: 8px; object-fit: cover; cursor: pointer;
      border: 2px solid transparent; transition: transform .15s ease, border-color .15s ease; outline: none; }
    .thumb:hover { transform: scale(1.04); }
    .thumb:focus-visible { outline: 2px solid #0d6efd; outline-offset: 2px; }
    .thumb.active { border-color: #0d6efd; }
  </style>

  <div class="container mt-4 position-relative">
    <div class="card mx-auto shadow" style="max-width: 650px;">
      <div class="card-header bg-white d-flex align-items-center justify-content-between">
        <h3 class="h5 mb-0 fw-bold text-primary">Detalle del equipo</h3>

        {isAdmin && (
          <button class="btn btn-sm btn-outline-danger d-flex align-items-center"
            onclick={`eliminarTicket('${equipo.id}')`} title="Eliminar ticket">
            <i class="bi bi-trash"></i>
          </button>
        )}
      </div>

      <div class="card-body">
        <div class="text-center mb-3">
          <img id="imagen-equipo" src={`${imagenPrincipal}?t=${Date.now()}`} alt="Imagen impresora"
            class="rounded img-fluid shadow-sm"
            style="max-height: 300px; max-width: 300px; object-fit: cover; border-radius: 15px; cursor: zoom-in;" />
        </div>

        {imagenes.length > 0 && (
          <div class="thumbs mb-4" id="thumbs">
            {imagenes.map((src) => (
              <img src={`${src}?t=${Date.now()}`} data-src={src} alt="Miniatura"
                class={`thumb ${src === imagenPrincipal ? 'active' : ''}`} role="button" tabindex="0" />
            ))}
          </div>
        )}

        <div class="text-center mb-4">
          <h4 class="fw-bold text-dark mb-1">{equipo?.cliente?.cliente ?? '—'}</h4>
          <div class="text-muted small">{modeloMostrado}</div>

          <div class="row row-cols-1 row-cols-md-2 g-4 justify-content-center mt-3">
            <div class="col"><strong>Ticket:</strong> {equipo?.ticket ?? '—'}</div>
            <div class="col"><strong>Estado:</strong> {equipo?.estado ?? '—'}</div>
            <div class="col"><strong>¿Cobrado?:</strong> {booleanATexto(equipo?.delivery?.pagado === 'true')}</div>
            <div class="col"><strong>Técnico:</strong> {equipo?.tecnico ? `${equipo.tecnico.nombre} ${equipo.tecnico.apellido}` : '—'}</div>
            <div class="col"><strong>DNI/CUIT:</strong> {equipo?.cliente?.dni_cuit ?? '—'}</div>
            <div class="col"><strong>Correo:</strong> {equipo?.cliente?.correo_electronico ?? '—'}</div>
            <div class="col"><strong>WhatsApp:</strong> {equipo?.cliente?.whatsapp ?? '—'}</div>
            <div class="col"><strong>Fecha formulario:</strong> {equipo?.marca_temporal ? formatearFecha(equipo.marca_temporal) : '—'}</div>
            <div class="col"><strong>Fecha listo:</strong> {equipo?.fecha_de_reparacion ? formatearFecha(equipo.fecha_de_reparacion) : '—'}</div>
          </div>
        </div>

        {(isAdmin || isTecnico) && (
          <>
            <div class="row mt-4 g-2">
              <div class={`d-flex ${isAdmin ? 'col-6' : 'col-12'}`}>
                {hasPresupuesto ? (
                  <a href={`/presupuesto/${equipo.id}`} class="btn btn-outline-primary btn-sm w-100">
                    <i class="bi bi-shield-check"></i> Verificar presupuesto
                  </a>
                ) : (
                  <a href={`/presupuesto/${equipo.id}`} class="btn btn-outline-primary btn-sm w-100">
                    <i class="bi bi-receipt"></i> Añadir presupuesto
                  </a>
                )}
              </div>

              {isAdmin && (
                <div class="col-6 d-flex">
                  <a href={`/delivery/${equipo.id}`} class="btn btn-outline-success btn-sm w-100">
                    <i class="bi bi-truck"></i> {hasDelivery ? 'Verificar delivery' : 'Añadir delivery'}
                  </a>
                </div>
              )}
            </div>

            <!-- Botón: Máquina Lista -->
            <div class="mt-3">
              {equipo?.estado !== 'Lista' ? (
                <button class="btn btn-warning w-100" onclick={`window.maquinaLista('${equipo.id}')`}>
                  <i class="bi bi-check2-square me-1"></i> Máquina Lista
                </button>
              ) : (
                <button class="btn btn-secondary w-100" disabled>
                  <i class="bi bi-check2-circle me-1"></i> Máquina ya marcada como Lista
                </button>
              )}
            </div>
          </>
        )}

        {!equipo && <div class="alert alert-danger mt-4">No se encontró el equipo con ID: {id}</div>}
      </div>
    </div>
  </div>

  {isAdmin && (
    <script>
      (window as any).eliminarTicket = async function(id) {
        if (!confirm("¿Estás seguro de que querés eliminar este ticket? Esta acción no se puede deshacer.")) return;
        const res = await fetch(`/api/eliminarTicket?id=${id}`, { method: 'POST' });
        const data = await res.json();
        if (res.ok) { alert("Ticket eliminado correctamente."); window.location.href = '/dashboard'; }
        else { alert("Error al eliminar: " + data.error); }
      }
    </script>
  )}

  <script>
    // Declaración segura para TypeScript
    (window as any).maquinaLista = async function(id) {
      if (!confirm("¿Marcar este equipo como LISTA? Esto actualizará el estado y la fecha de listo.")) return;

      const elements = document.querySelectorAll('button, a.btn');

      // Deshabilitar botones y anchors
      elements.forEach((el) => {
        if (el instanceof HTMLButtonElement) {
          el.disabled = true;
        } else if (el instanceof HTMLAnchorElement) {
          el.classList.add('disabled');
          el.setAttribute('aria-disabled', 'true');
          el.style.pointerEvents = 'none';
        }
      });

      try {
        const res = await fetch(`/api/maquinaLista?id=${encodeURIComponent(id)}`, { method: 'POST' });

        if (res.redirected) {
          window.location.href = res.url;
          return;
        }
        if (res.ok) {
          window.location.reload();
          return;
        }

        const data = await res.json().catch(() => ({}));
        alert("No se pudo marcar como Lista: " + (data.error || res.statusText));
      } catch (e) {
        alert("Error de red: " + (e && (e as any).message ? (e as any).message : String(e)));
      } finally {
        // Rehabilitar
        elements.forEach((el) => {
          if (el instanceof HTMLButtonElement) {
            el.disabled = false;
          } else if (el instanceof HTMLAnchorElement) {
            el.classList.remove('disabled');
            el.removeAttribute('aria-disabled');
            el.style.pointerEvents = '';
          }
        });
      }
    }
  </script>

  <script src="/scripts/form-ampliar-imagen.js" defer></script>
  <script src="/scripts/form-galeria.js?v=1" defer></script>
</BasePrivateLayout>
