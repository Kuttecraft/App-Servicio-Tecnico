---
import BasePrivateLayout from '../../layouts/BasePrivateLayout.astro';
import { supabase } from '../../lib/supabase';

const { id } = Astro.params as { id: string };

type Perfil = { rol?: string; admin?: boolean; activo?: boolean };
const perfil = (Astro.locals as any).perfil as Perfil | undefined;
const isAdmin = (perfil?.rol === 'admin') || (perfil?.admin === true);
const isTecnico = perfil?.rol === 'tecnico';

// Ticket para cabecera
const { data: ticket } = await supabase
  .from('tickets_mian')
  .select(`
    id, ticket, estado,
    cliente:cliente_id ( cliente )
  `)
  .eq('id', id)
  .maybeSingle();

// Comentarios (últimos primero)
const { data: comentarios, count: totalComentarios } = await supabase
  .from('ticket_comentarios')
  .select(`
    id,
    mensaje,
    creado_en,
    autor:autor_id ( nombre, apellido )
  `, { count: 'exact' })
  .eq('ticket_id', id)
  .order('creado_en', { ascending: false });

const fechaHoraAR = (iso?: string | null) => {
  if (!iso) return '—';
  try { return new Date(iso).toLocaleString('es-AR', { hour12: false }); }
  catch { return iso; }
};

const getAutorNombre = (autor: any): string => {
  const a = Array.isArray(autor) ? autor[0] : autor;
  if (!a) return '—';
  const nom = (a?.nombre ?? '').toString();
  const ape = (a?.apellido ?? '').toString();
  return `${nom} ${ape}`.trim() || '—';
};
const getClienteNombre = (cli: any): string | null => {
  const c = Array.isArray(cli) ? cli[0] : cli;
  if (!c) return null;
  const nombre = (c?.cliente ?? '').toString().trim();
  return nombre || null;
};
---

<BasePrivateLayout>
  <div class="container mt-4">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h1 class="h5 mb-0">
        Comentarios del Ticket #{ticket?.ticket ?? ticket?.id ?? id}
        {getClienteNombre(ticket?.cliente) && (
          <small class="text-muted"> — {getClienteNombre(ticket?.cliente)}</small>
        )}
      </h1>

      <a href={`/detalle/${id}`} class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Volver al detalle
      </a>
    </div>

    <div class="card shadow-sm">
      <div class="card-header bg-white d-flex align-items-center justify-content-between">
        <div>
          <strong>Historial</strong>
          <span class="text-muted">(<span id="comentarios-count">{totalComentarios ?? 0}</span>)</span>
        </div>
        {(isAdmin || isTecnico) && <span class="text-muted small">Append-only</span>}
      </div>

      <div class="card-body">
        {(isAdmin || isTecnico) && (
          <form id="form-comentario" class="mb-3" data-ticketid={id}>
            <div class="input-group">
              <textarea
                class="form-control"
                id="comentario-texto"
                placeholder="Agregar comentario (p. ej. 'Revisar extrusor')"
                rows="2"
                maxlength="2000"
                required
              ></textarea>
              <button class="btn btn-primary" type="submit">
                <i class="bi bi-send"></i> Agregar
              </button>
            </div>
            <div class="form-text">No se puede editar ni borrar.</div>
          </form>
        )}

        <!-- SIEMPRE renderizamos la UL aunque esté vacía -->
        <ul class="list-group" id="comentarios-lista">
          {Array.isArray(comentarios) && comentarios.length > 0 && comentarios.map((c) => (
            <li class="list-group-item">
              <div class="small text-muted">
                <strong>{getAutorNombre(c.autor)}</strong>
                · {fechaHoraAR(c.creado_en)}
              </div>
              <div>{c.mensaje}</div>
            </li>
          ))}
        </ul>

        {/* Mensaje de vacío controlado por JS */}
        <div id="no-comentarios" class="text-muted" style={{ display: (Array.isArray(comentarios) && comentarios.length > 0) ? 'none' : '' }}>
          No hay comentarios todavía.
        </div>
      </div>
    </div>
  </div>

  <script>
    // Alta de comentario con Optimistic UI (sin recargar)
    (function(){
      const form = document.getElementById('form-comentario') as HTMLFormElement | null;
      if (!form) return;

      const textarea = document.getElementById('comentario-texto') as HTMLTextAreaElement | null;
      const lista = document.getElementById('comentarios-lista') as HTMLUListElement | null;
      const noMsg = document.getElementById('no-comentarios') as HTMLDivElement | null;
      const countEl = document.getElementById('comentarios-count') as HTMLSpanElement | null;

      const ticketId = form.dataset.ticketid ? Number(form.dataset.ticketid) : null;

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = form.querySelector('button[type="submit"]') as HTMLButtonElement | null;

        const mensaje = (textarea?.value || '').trim();
        if (!mensaje || !Number.isFinite(ticketId)) return;

        if (btn) btn.disabled = true;

        try {
          const res = await fetch('/api/agregarComentario', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ticketId, mensaje })
          });

          const data = await res.json();

          if (!res.ok) {
            alert(data?.error || 'No se pudo agregar el comentario.');
            return;
          }

          // ocultar mensaje "no hay comentarios"
          if (noMsg && noMsg.style.display !== 'none') noMsg.style.display = 'none';

          // crear <li> y prepender al <ul>
          if (lista) {
            const li = document.createElement('li');
            li.className = 'list-group-item';
            const fechaHumana = data?.creado_en_humano || new Date().toLocaleString('es-AR', { hour12: false });
            const autor = data?.autor || 'Vos';

            li.innerHTML = `
              <div class="small text-muted">
                <strong></strong> · <span class="fecha"></span>
              </div>
              <div class="mensaje"></div>
            `;
            (li.querySelector('strong') as HTMLElement).textContent = autor;
            (li.querySelector('.fecha') as HTMLElement).textContent = fechaHumana;
            (li.querySelector('.mensaje') as HTMLElement).textContent = mensaje;

            if (lista.firstChild) lista.insertBefore(li, lista.firstChild);
            else lista.appendChild(li);
          }

          // limpiar textarea y contar
          if (textarea) {
            textarea.value = '';
            textarea.focus();
          }
          if (countEl) {
            const n = parseInt(countEl.textContent || '0', 10) || 0;
            countEl.textContent = String(n + 1);
          }

        } catch (err) {
          alert('Error de red: ' + (err && (err as any).message ? (err as any).message : String(err)));
        } finally {
          if (btn) btn.disabled = false;
        }
      });
    })();
  </script>
</BasePrivateLayout>
