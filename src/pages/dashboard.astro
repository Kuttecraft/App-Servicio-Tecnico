---
import BasePrivateLayout from '../layouts/BasePrivateLayout.astro';
import PrinterCard from '../components/PrinterCard.astro';
import { supabase } from '../lib/supabase';


// Paginación
const pageParam = Astro.url.searchParams.get('page') || '1';
const currentPage = parseInt(pageParam);
const itemsPerPage = 500;
const from = (currentPage - 1) * itemsPerPage;
const to = from + itemsPerPage - 1;

// Consulta combinada (ahora también se trae la imagen)
const { data: impresoras } = await supabase
  .from('tickets_mian')
  .select(`
    id,
    ticket,
    estado,
    imagen,
    impresora:impresoras (
      modelo
    ),
    cliente:cliente (
      cliente,
      whatsapp
    )
  `)
  .order('id', { ascending: false }) 
  .range(from, to);
---

<BasePrivateLayout>
  <div class="container mt-4">

    {impresoras && impresoras.length > 0 ? (
      <div class="row g-4">
        {impresoras.map((item: any) => (
          <div class="col-sm-6 col-md-4 col-lg-3">
            <PrinterCard
              id={item.id}
              ticket={item.ticket || 'Sin ticket'}
              cliente={item.cliente?.cliente || 'Desconocido'}
              maquina={item.impresora?.modelo || 'Desconocido'}
              estado={item.estado || 'Desconocido'}
              whatsapp={item.cliente?.whatsapp || 'No especificado'}
              imagen={item.imagen || null}          
              onClickUrl={`/detalle/${item.id}`}
              onClickUrlEditar={`/editar/${item.id}`}
            />
          </div>
        ))}
      </div>
    ) : (
      <div class="text-center">
        <p class="text-muted">⚠️ No hay impresoras registradas.</p>
      </div>
    )}

    <!-- Navegación -->
    <div class="d-flex justify-content-center mt-4 gap-2">
      {currentPage > 1 && (
        <a href={`?page=${currentPage - 1}`} class="btn btn-outline-secondary">
          Anterior
        </a>
      )}
      <span class="align-self-center">Página {currentPage}</span>
      {impresoras.length === itemsPerPage && (
        <a href={`?page=${currentPage + 1}`} class="btn btn-outline-secondary">
          Siguiente
        </a>
      )}
    </div>

  </div>
</BasePrivateLayout>
