---
import BasePrivateLayout from '../layouts/BasePrivateLayout.astro';
import PrinterCard from '../components/PrinterCard.astro';
import { supabase } from '../lib/supabase';

// Par치metros de filtro (la UI vive ahora en el Topbar)
const by = Astro.url.searchParams.get('by') || 'id';
const rawQ = Astro.url.searchParams.get('q') || '';
const q = rawQ.trim();

// Paginaci칩n
const pageParam = Astro.url.searchParams.get('page') || '1';
const currentPage = parseInt(pageParam);
const itemsPerPage = 500;
const from = (currentPage - 1) * itemsPerPage;
const to = from + itemsPerPage - 1;

// SELECT base (agregamos !inner SOLO cuando hace falta)
let selectStr = `
  id,
  ticket,
  estado,
  imagen,
  impresora:impresoras (modelo),
  cliente:cliente (cliente, whatsapp)
`;

if (by === 'cliente') {
  selectStr = `
    id,
    ticket,
    estado,
    imagen,
    impresora:impresoras (modelo),
    cliente:cliente!inner (cliente, whatsapp)
  `;
}
if (by === 'maquina') {
  selectStr = `
    id,
    ticket,
    estado,
    imagen,
    impresora:impresoras!inner (modelo),
    cliente:cliente (cliente, whatsapp)
  `;
}

let query = supabase.from('tickets_mian').select(selectStr);

// Filtros
if (q) {
  const qNum = Number.isFinite(Number(q)) ? Number(q) : null;

  switch (by) {
    case 'id':
      query = qNum !== null ? query.eq('id', qNum) : query.eq('id', -1);
      break;
    case 'ticket':
      query = qNum !== null ? query.eq('ticket', qNum) : query.eq('ticket', -1);
      break;
    case 'estado':
      query = query.eq('estado', q); // igualdad por el select
      break;
    case 'cliente':
      query = query.ilike('cliente.cliente', `%${q}%`);
      break;
    case 'maquina':
      query = query.ilike('impresora.modelo', `%${q}%`);
      break;
    default:
      break;
  }
}

// Orden + rango
query = query.order('id', { ascending: false }).range(from, to);

// Ejecutar
const { data, error } = await query;
// Blindamos: nunca dejar que impresoras sea null/undefined para evitar .length de null
const impresoras = Array.isArray(data) ? data : [];
if (error) console.error('Error supabase:', error, { by, q });
---

<BasePrivateLayout showFilters={true}>
  <div class="container mt-4">

    <!-- Resultados -->
    {Array.isArray(impresoras) && impresoras.length > 0 ? (
      <div class="row g-4">
        {impresoras.map((item: any) => (
          <div class="col-sm-6 col-md-4 col-lg-3">
            <PrinterCard
              id={item.id}
              ticket={item.ticket || 'Sin ticket'}
              cliente={item.cliente?.cliente || 'Desconocido'}
              maquina={item.impresora?.modelo || 'Desconocido'}
              estado={item.estado || 'Desconocido'}
              whatsapp={item.cliente?.whatsapp || 'No especificado'}
              imagen={item.imagen || null}
              onClickUrl={`/detalle/${item.id}`}
              onClickUrlEditar={`/editar/${item.id}`}
            />
          </div>
        ))}
      </div>
    ) : (
      <div class="text-center">
        <p class="text-muted">{error ? 'Error al cargar resultados' : 'No hay resultados.'}</p>
      </div>
    )}

    <!-- Navegaci칩n -->
    <div class="d-flex justify-content-center mt-4 gap-2">
      {currentPage > 1 && (
        <a
          href={`?${new URLSearchParams({
            q,
            by,
            page: String(currentPage - 1)
          }).toString()}`}
          class="btn btn-outline-secondary"
        >
          Anterior
        </a>
      )}
      <span class="align-self-center">P치gina {currentPage}</span>
      {Array.isArray(impresoras) && impresoras.length === itemsPerPage && (
        <a
          href={`?${new URLSearchParams({
            q,
            by,
            page: String(currentPage + 1)
          }).toString()}`}
          class="btn btn-outline-secondary"
        >
          Siguiente
        </a>
      )}
    </div>

  </div>
</BasePrivateLayout>
