---
import BasePrivateLayout from '../../layouts/BasePrivateLayout.astro';
import DeliveryForm from '../../components/DeliveryForm.astro';
import { supabase } from '../../lib/supabase';

const url = new URL(Astro.request.url);

// Precarga por URL (el backend ignora fecha_de_entrega)
const precarga = {
  cotizar_delivery: url.searchParams.get('cotizar_delivery') ?? undefined,
  informacion_adicional_delivery: url.searchParams.get('informacion_adicional_delivery') ?? undefined,
  medio_de_entrega: url.searchParams.get('medio_de_entrega') ?? undefined,
  fecha_de_entrega: url.searchParams.get('fecha_de_entrega') ?? undefined,
  forma_de_pago: url.searchParams.get('forma_de_pago') ?? undefined,
  pagado: url.searchParams.get('pagado') ?? undefined,
  direccion: url.searchParams.get('direccion') ?? undefined,
  localidad: url.searchParams.get('localidad') ?? undefined,
};

const { id } = Astro.params;

// 1) Traemos el ticket y, JOIN, los datos del cliente
const { data: ticket } = await supabase
  .from('tickets_mian')
  .select(`
    id,
    ticket,
    cliente_id,
    cliente:cliente_id ( cliente, direccion, localidad, informacion_adicional_usuario )
  `)
  .eq('id', id)
  .single();

// 2) Traemos (si existe) el delivery del ticket
const { data: delivery } = await supabase
  .from('delivery')
  .select('*')
  .eq('ticket_id', id)
  .maybeSingle();

// 3) Mezclamos: primero delivery; si falta algo, usamos cliente; luego lo que venga por querystring
const equipo = {
  ticketId: ticket?.id,
  ticketNumero: ticket?.ticket,

  // Campos propios de delivery (si ya existieran)
  ...delivery,

  // Fallbacks desde cliente cuando en delivery están vacíos
  direccion:
    (delivery as any)?.direccion ??
    (ticket as any)?.cliente?.direccion ??
    undefined,

  localidad:
    (delivery as any)?.localidad ??
    (ticket as any)?.cliente?.localidad ??
    undefined,

  // Si querés precargar info adicional con la que trae cliente:
  informacion_adicional_delivery:
    (delivery as any)?.informacion_adicional_delivery ??
    (ticket as any)?.cliente?.informacion_adicional_usuario ??
    undefined,

  // Por último, sobrescribe cualquier precarga por URL
  ...Object.fromEntries(Object.entries(precarga).filter(([_, v]) => v !== undefined)),
};
---

<BasePrivateLayout>
  <div class="container mt-5">
    <h2 class="mb-4"><i class="bi bi-truck me-2"></i> Añadir delivery</h2>

    {equipo?.ticketId
      ? <DeliveryForm equipo={equipo} />
      : <div class="alert alert-danger">No se encontró el ticket con ID: {id}</div>
    }
  </div>
</BasePrivateLayout>
