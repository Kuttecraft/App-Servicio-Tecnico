---
import BasePrivateLayout from '../../layouts/BasePrivateLayout.astro';
import DeliveryForm from '../../components/DeliveryForm.astro';
import { supabase } from '../../lib/supabase';

const url = new URL(Astro.request.url);

// Precarga por URL (el backend ignora fecha_de_entrega)
const precarga = {
  cotizar_delivery: url.searchParams.get('cotizar_delivery') ?? undefined,
  informacion_adicional_delivery: url.searchParams.get('informacion_adicional_delivery') ?? undefined,
  medio_de_entrega: url.searchParams.get('medio_de_entrega') ?? undefined,
  fecha_de_entrega: url.searchParams.get('fecha_de_entrega') ?? undefined,
  forma_de_pago: url.searchParams.get('forma_de_pago') ?? undefined,
  pagado: url.searchParams.get('pagado') ?? undefined,
  direccion: url.searchParams.get('direccion') ?? undefined,
  localidad: url.searchParams.get('localidad') ?? undefined,
};

const { id } = Astro.params;

// 1) Ticket + datos básicos de cliente
const { data: ticket } = await supabase
  .from('tickets_mian')
  .select(`
    id,
    ticket,
    cliente_id,
    cliente:cliente_id ( cliente, direccion, localidad, informacion_adicional_usuario )
  `)
  .eq('id', id)
  .single();

// 2) Último delivery del ticket (si existiera)
const { data: deliveryRows } = await supabase
  .from('delivery')
  .select('*')
  .eq('ticket_id', id)
  .order('id', { ascending: false })
  .limit(1);

const delivery = Array.isArray(deliveryRows) ? deliveryRows[0] : null;

// 3) Mezcla: delivery → cliente → precarga
const equipo = {
  ticketId: ticket?.id,
  ticketNumero: ticket?.ticket,
  ...delivery,
  direccion:
    (delivery as any)?.direccion ??
    (ticket as any)?.cliente?.direccion ??
    undefined,
  localidad:
    (delivery as any)?.localidad ??
    (ticket as any)?.cliente?.localidad ??
    undefined,
  informacion_adicional_delivery:
    (delivery as any)?.informacion_adicional_delivery ??
    (ticket as any)?.cliente?.informacion_adicional_usuario ??
    undefined,
  ...Object.fromEntries(Object.entries(precarga).filter(([_, v]) => v !== undefined)),
};
---

<BasePrivateLayout>
  <div class="container mt-5">
    <h2 class="mb-4"><i class="bi bi-truck me-2"></i> Añadir delivery</h2>

    {equipo?.ticketId
      ? <DeliveryForm equipo={equipo} />
      : <div class="alert alert-danger">No se encontró el ticket con ID: {id}</div>
    }
  </div>
</BasePrivateLayout>
