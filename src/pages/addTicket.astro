---
import BasePrivateLayout from '../layouts/BasePrivateLayout.astro';

const url = new URL(Astro.request.url);

const ok = url.searchParams.get('ok') === '1';

const cliente = ok ? '' : (url.searchParams.get('cliente') || '');
const dniCuit = ok ? '' : (url.searchParams.get('dniCuit') || '');
const correo = ok ? '' : (url.searchParams.get('correo') || '');
const whatsapp = ok ? '' : (url.searchParams.get('whatsapp') || '');
// ⚠️ Ya no usamos "modelo"
const maquina = ok ? '' : (url.searchParams.get('maquina') || '');
const numeroSerie = ok ? '' : (url.searchParams.get('numeroSerie') || '');
const boquilla = ok ? '' : (url.searchParams.get('boquilla') || '');
const tecnico = ok ? '' : (url.searchParams.get('tecnico') || '');
const comentarios = ok ? '' : (url.searchParams.get('comentarios') || '');

const estados = [
  "Nuevo", "Retirar", "Presupuestar", "Enviar presupuesto", "P. Enviado",
  "Reparación", "Prueba", "Lista", "Entregada",
  "Feedback Enviado", "Archivada", "No realizada"
];
const estado = ok ? estados[0] : (url.searchParams.get('estado') || estados[0]);

let ticketSugerido = 1;
try {
  let base = Astro.site?.toString() || 'http://localhost:4321';
  const res = await fetch(`${base}/api/proximoTicket`);
  if (res.ok) {
    const data = await res.json();
    ticketSugerido = data.sugerido;
  }
} catch {
  ticketSugerido = 1;
}

// ⚠️ clave: si venimos de ok=1, ignoramos cualquier ?ticket= de la URL
const ticket = ok
  ? ticketSugerido
  : (url.searchParams.get('ticket') || ticketSugerido);

const cobrado = "No";
---

<BasePrivateLayout>
  <style>
    .image-tiles { display: flex; gap: 1.25rem; justify-content: center; flex-wrap: wrap; }
    .image-tile {
      position: relative; width: 280px; height: 280px; border-radius: 16px;
      overflow: hidden; background: #f1f3f5; border: 1px solid rgba(0,0,0,.075);
      box-shadow: 0 2px 8px rgba(0,0,0,.06);
      display: flex; align-items: center; justify-content: center;
      transition: box-shadow .2s ease;
    }
    .image-tile:hover { box-shadow: 0 4px 16px rgba(0,0,0,.08); }
    .image-tile img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .upload-btn { cursor: pointer; }
    .add-tile { background: #e9ecef; color: #6c757d; cursor: pointer; display: none; }
    .add-tile .plus { font-size: 64px; line-height: 1; user-select: none; display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; }
    .hidden-input { display: none; }
    .image-tile.has-image .upload-btn { display: none; }
    .image-tile.has-image { cursor: pointer; }
  </style>

  <div class="container mt-5">
    <div class="d-flex align-items-center justify-content-between">
      <h2 class="mb-4"><i class="bi bi-ticket-perforated me-2"></i> Crear nuevo ticket</h2>

      {ok && (
        <span class="badge bg-success-subtle text-success border border-success-subtle">
          Ticket creado ✅
        </span>
      )}
    </div>

    <form method="post" action="/api/crearTicket" enctype="multipart/form-data" class="row g-3" id="form-crear-ticket">
      <div class="col-md-6">
        <label class="form-label">Cliente</label>
        <input type="text" class="form-control" name="cliente" value={cliente} required />
      </div>
      <div class="col-md-6">
        <label class="form-label">DNI/CUIT</label>
        <input type="text" class="form-control" name="dniCuit" value={dniCuit} />
      </div>

      <div class="col-md-6">
        <label class="form-label">Correo</label>
        <input type="email" class="form-control" name="correo" value={correo} />
      </div>

      <div class="col-md-6">
        <label class="form-label">Ticket</label>
        <input type="number" class="form-control" name="ticket" value={ticket} min={1} required />
      </div>

      <div class="col-md-6">
        <label class="form-label">WhatsApp</label>
        <input type="text" class="form-control" name="whatsapp" value={whatsapp} />
      </div>

      <!-- ✅ Volvió "Máquina" -->
      <div class="col-md-6">
        <label class="form-label">Máquina</label>
        <input type="text" class="form-control" name="maquina" value={maquina} />
      </div>

      <!-- Ya no hay "Modelo" -->

      <div class="col-md-6">
        <label class="form-label">N° de Serie</label>
        <input type="text" class="form-control" name="numeroSerie" value={numeroSerie} />
      </div>
      <div class="col-md-6">
        <label class="form-label">Tamaño de boquilla</label>
        <input type="text" class="form-control" name="boquilla" value={boquilla} />
      </div>

      <div class="col-md-6">
        <label class="form-label">Técnico</label>
        <input type="text" class="form-control" name="tecnico" value={tecnico} />
      </div>

      <div class="col-md-6">
        <label class="form-label">Estado</label>
        <select class="form-select" name="estado" required>
          {estados.map((op) => (
            <option value={op} selected={op === estado}>{op}</option>
          ))}
        </select>
      </div>

      <input type="hidden" name="cobrado" value="No" />

      <div class="col-12">
        <label class="form-label">Comentarios</label>
        <textarea class="form-control" name="comentarios">{comentarios}</textarea>
      </div>

      <!-- Imágenes -->
      <div class="col-12">
        <label class="form-label d-block text-center mb-2">Imágenes</label>
        <div class="image-tiles">
          <div class="image-tile" id="tile-principal">
            <img id="previewPrincipal" src="/logo.webp" alt="Vista previa principal" class="d-none" />
            <label class="btn btn-outline-primary upload-btn position-absolute" style="bottom:12px; left:50%; transform:translateX(-50%);">
              <i class="bi bi-upload me-2"></i> Subir imagen
              <input type="file" class="hidden-input" name="imagenArchivo" id="imagenArchivo" accept="image/*" />
            </label>
          </div>

          <div class="image-tile add-tile" id="tile-plus-ticket" title="Añadir imagen de ticket">
            <div class="plus">+</div>
          </div>

          <div class="image-tile d-none" id="tile-ticket">
            <img id="previewTicket" src="/logo.webp" alt="Vista previa ticket" class="d-none" />
            <label class="btn btn-outline-primary upload-btn position-absolute" style="bottom:12px; left:50%; transform:translateX(-50%);">
              <i class="bi bi-upload me-2"></i> Subir imagen ticket
              <input type="file" class="hidden-input" name="imagenTicketArchivo" id="imagenTicketArchivo" accept="image/*" />
            </label>
          </div>

          <div class="image-tile add-tile d-none" id="tile-plus-extra" title="Añadir imagen extra">
            <div class="plus">+</div>
          </div>

          <div class="image-tile d-none" id="tile-extra">
            <img id="previewExtra" src="/logo.webp" alt="Vista previa extra" class="d-none" />
            <label class="btn btn-outline-primary upload-btn position-absolute" style="bottom:12px; left:50%; transform:translateX(-50%);">
              <i class="bi bi-upload me-2"></i> Subir imagen extra
              <input type="file" class="hidden-input" name="imagenExtraArchivo" id="imagenExtraArchivo" accept="image/*" />
            </label>
          </div>
        </div>
      </div>

      <div class="col-12 text-center">
        <button type="submit" class="btn btn-primary mt-3 px-5">Crear ticket</button>
      </div>
    </form>
  </div>

  <!-- Mensajito visual al volver con ok=1 -->
  <script is:inline>
    (function() {
      const usp = new URLSearchParams(location.search);
      if (usp.get('ok') === '1') {
        document.getElementById('previewPrincipal')?.classList.add('d-none');
        document.getElementById('previewTicket')?.classList.add('d-none');
        document.getElementById('previewExtra')?.classList.add('d-none');
        const first = document.querySelector('input[name="cliente"]');
        if (first) first.focus();
      }
    })();
  </script>

  <script src="https://unpkg.com/browser-image-compression@latest/dist/browser-image-compression.js" defer></script>
  <script src="/scripts/form-crear-ticket-multi.js?v=2" defer></script>
</BasePrivateLayout>
